#### Regret

##### Regret per trial

```{r}
regret <- function(choices) { 
    return(cumsum(W_OPT - as.double(as.character(choices))))
}
```


```{r}
# choices is vector of all choices, numbers should represent the order of the hidden probabilities
W_OPT = .6
# hidden_prob = c(0.075, 0.15, 0.225, 0.3, 0.375, 0.45, 0.525, 0.6)
load("../processed/data.ev-final.RData", verbose = F)
alldata <- data.ev
games = 8 # number of games
pulls = 100
```

```{r}
data <- alldata[alldata$block_size == 4,]
# pdf("plot-average-regret.pdf", width=inch_width, height=inch_height, pointsize = pointsize)
par(mfrow=c(1,2))      # number of rows, number of columns
# pdf("plot-average-regret-4.pdf", width=inch_width, height=inch_height, pointsize = pointsize)
# png("plot-%d.png", width=inch_width, height=inch_height, pointsize = pointsize, units = "in", res = 600)
expected_total_regret = matrix(0, pulls, length(unique(data$age_group)))
expected_total_regret_sds = replicate(length(unique(data$age_group)), matrix(0, pulls, games), simplify = FALSE)
plot(1, type="n", ylab="Average regret", xlim=c(0, 100), ylim=c(0, 20), bty="n", cex.axis=1.2, xlab="Trial", cex.lab=1.4)
for(i in 1:length(unique(data$age_group))) {
  for(pp in unique(data$id[data$age_group == unique(data$age_group)[i]])) {
    for(tr in unique(data$block_id[data$id == pp])) {
      evchoices = data$ev[data$id == pp & data$block_id == tr] # keuzelijst #data$age_group == unique(data$age_group)[i] & 
      game_regret = regret(evchoices)
      expected_total_regret[, i] <- expected_total_regret[, i] + game_regret
      expected_total_regret_sds[[i]][, match(tr,unique(data$block_id[data$id == pp])) ] <- game_regret
    }
  } 
  pps <- length(unique(data$id[data$age_group == unique(data$age_group)[i]]))
  lines(expected_total_regret[, i] / (games*pps), col = i, lwd=1.5)
  sds <- transform(expected_total_regret_sds[[i]], SD=apply(expected_total_regret_sds[[i]],1, sd, na.rm = TRUE))[,9]
  se <- sds / sqrt(games*pps)  # Calculate standard error of the mean
  lines((expected_total_regret[, i] / (games*pps)) + se, col = i, lwd=1.5, lty = 2)
  lines((expected_total_regret[, i] / (games*pps)) - se, col = i, lwd=1.5, lty = 2)
} 
title("4-armed bandits")
legend("topleft", c("Young", "Old"), col = c(1, 2),
       text.col = "black", lty = c(1, 1), bg = "gray90")

data <- alldata[alldata$block_size == 8,]
expected_total_regret = matrix(0, pulls, length(unique(data$age_group)))
expected_total_regret_sds = replicate(length(unique(data$age_group)), matrix(0, pulls, games), simplify = FALSE)
plot(1, type="n", ylab="", xlim=c(0, 100), ylim=c(0, 20), bty="n", cex.axis=1.2, xlab="", cex.lab=1.4)
for(i in 1:length(unique(data$age_group))) {
  for(pp in unique(data$id[data$age_group == unique(data$age_group)[i]])) {
    for(tr in unique(data$block_id[data$id == pp])) {
      evchoices = data$ev[data$id == pp & data$block_id == tr] # keuzelijst #data$age_group == unique(data$age_group)[i] & 
      game_regret = regret(evchoices)
      expected_total_regret[, i] <- expected_total_regret[, i] + game_regret
      expected_total_regret_sds[[i]][, match(tr,unique(data$block_id[data$id == pp])) ] <- game_regret
    }
  } 
  pps <- length(unique(data$id[data$age_group == unique(data$age_group)[i]]))
  lines(expected_total_regret[, i] / (games*pps), col = i, lwd=1.5)
  sds <- transform(expected_total_regret_sds[[i]], SD=apply(expected_total_regret_sds[[i]],1, sd, na.rm = TRUE))[,9]
  se <- sds / sqrt(games*pps)  # Calculate standard error of the mean
  lines((expected_total_regret[, i] / (games*pps)) + se, col = i, lwd=1.5, lty = 2)
  lines((expected_total_regret[, i] / (games*pps)) - se, col = i, lwd=1.5, lty = 2)
} 
title("8-armed bandits")
# dev.off()
par(mfrow=c(1,1))     # sets the plot window back to normal
```



```{r}
data <- alldata[alldata$block_size == 4,]
# pdf("plot-average-regret-log.pdf", width=inch_width, height=inch_height, pointsize = pointsize)
par(mfrow=c(1,2))      # number of rows, number of columns
par(xlog=TRUE)
# pdf("plot-average-regret-4.pdf", width=inch_width, height=inch_height, pointsize = pointsize)
# png("plot-%d.png", width=inch_width, height=inch_height, pointsize = pointsize, units = "in", res = 600)
expected_total_regret = matrix(0, pulls, length(unique(data$age_group)))
expected_total_regret_sds = replicate(length(unique(data$age_group)), matrix(0, pulls, games), simplify = FALSE)
plot(1, type="n", ylab="Average regret", ylim=c(0, 20), xlim=c(1, 100), bty="n", cex.axis=1.2, xlab="Trial", cex.lab=1.4, log = "x")
for(i in 1:length(unique(data$age_group))) {
  for(pp in unique(data$id[data$age_group == unique(data$age_group)[i]])) {
    for(tr in unique(data$block_id[data$id == pp])) {
      evchoices = data$ev[data$id == pp & data$block_id == tr] # keuzelijst #data$age_group == unique(data$age_group)[i] & 
      game_regret = regret(evchoices)
      expected_total_regret[, i] <- expected_total_regret[, i] + game_regret
      expected_total_regret_sds[[i]][, match(tr,unique(data$block_id[data$id == pp])) ] <- game_regret
    }
  } 
  pps <- length(unique(data$id[data$age_group == unique(data$age_group)[i]]))
  lines(expected_total_regret[, i] / (games*pps), col = i, lwd=1.5, log = "x")
  sds <- transform(expected_total_regret_sds[[i]], SD=apply(expected_total_regret_sds[[i]],1, sd, na.rm = TRUE))[,9]
  se <- sds / sqrt(games*pps)  # Calculate standard error of the mean
  lines((expected_total_regret[, i] / (games*pps)) + se, col = i, lwd=1.5, lty = 2, log = "x")
  lines((expected_total_regret[, i] / (games*pps)) - se, col = i, lwd=1.5, lty = 2, log = "x")
} 
title("4-armed bandits")
legend("topleft", c("Young", "Old"), col = c(1, 2),
       text.col = "black", lty = c(1, 1), bg = "gray90")

data <- alldata[alldata$block_size == 8,]
# pdf("plot-average-regret-8.pdf", width=inch_width, height=inch_height, pointsize = pointsize)
# png("plot-%d.png", width=inch_width, height=inch_height, pointsize = pointsize, units = "in", res = 600)
expected_total_regret = matrix(0, pulls, length(unique(data$age_group)))
expected_total_regret_sds = replicate(length(unique(data$age_group)), matrix(0, pulls, games), simplify = FALSE)
par(xlog=TRUE)
plot(1, type="n", ylab="", xlim=c(1, 100), ylim=c(0, 20), bty="n", cex.axis=1.2, xlab="", cex.lab=1.4, log = "x")
for(i in 1:length(unique(data$age_group))) {
  for(pp in unique(data$id[data$age_group == unique(data$age_group)[i]])) {
    for(tr in unique(data$block_id[data$id == pp])) {
      evchoices = data$ev[data$id == pp & data$block_id == tr] # keuzelijst #data$age_group == unique(data$age_group)[i] & 
      game_regret = regret(evchoices)
      expected_total_regret[, i] <- expected_total_regret[, i] + game_regret
      expected_total_regret_sds[[i]][, match(tr,unique(data$block_id[data$id == pp])) ] <- game_regret
    }
  } 
  pps <- length(unique(data$id[data$age_group == unique(data$age_group)[i]]))
  lines(expected_total_regret[, i] / (games*pps), col = i, lwd=1.5, log = "x")
  sds <- transform(expected_total_regret_sds[[i]], SD=apply(expected_total_regret_sds[[i]],1, sd, na.rm = TRUE))[,9]
  se <- sds / sqrt(games*pps)  # Calculate standard error of the mean
  lines((expected_total_regret[, i] / (games*pps)) + se, col = i, lwd=1.5, lty = 2, log = "x")
  lines((expected_total_regret[, i] / (games*pps)) - se, col = i, lwd=1.5, lty = 2, log = "x")
} 
title("8-armed bandits")
# dev.off()
par(mfrow=c(1,1))     # sets the plot window back to normal
```









##### Regret per participant


```{r}
data <- alldata[alldata$block_size == 4,]
data$regret = 0
# pps <- length(unique(data$id))
# expected_total_regret_sds = matrix(0, pulls, games*pps)

id = 0
for(pp in unique(data$id)) {
	for(tr in unique(data$block_id[data$id == pp])) {
	  evchoices = data$ev[data$id == pp & data$block_id == tr] # keuzelijst #data$age_group == unique(data$age_group)[i] & 
	  game_regret = regret(evchoices)
	  data$regret[data$id == pp & data$block_id == tr] = game_regret
# 	  expected_total_regret_sds[, id*games + match(tr,unique(data$block_id[data$id == pp])) ] <- game_regret
	}
	id = id + 1
} 
data4 = data
# sds <- transform(expected_total_regret_sds, SD=apply(expected_total_regret_sds,1, sd, na.rm = TRUE))[,games*pps + 1]
# se4 <- sds / sqrt(games*pps)  # Calculate standard error of the mean

data <- alldata[alldata$block_size == 8,]
# pps <- length(unique(data$id))
# expected_total_regret_sds = matrix(0, pulls, games*pps)
id = 0
for(pp in unique(data$id)) {
	for(tr in unique(data$block_id[data$id == pp])) {
	  evchoices = data$ev[data$id == pp & data$block_id == tr] # keuzelijst #data$age_group == unique(data$age_group)[i] & 
	  game_regret = regret(evchoices)
	  data$regret[data$id == pp & data$block_id == tr] = game_regret
# 	  expected_total_regret_sds[, id*games + match(tr,unique(data$block_id[data$id == pp])) ] <- game_regret
	}
	id = id + 1
} 
data8 = data
# sds <- transform(expected_total_regret_sds, SD=apply(expected_total_regret_sds,1, sd, na.rm = TRUE))[,games*pps + 1]
# se8 <- sds / sqrt(games*pps)  # Calculate standard error of the mean

# se4
# se8

data = rbind(data4, data8)
alldata = data
```



```{r, echo=FALSE}
agg = "id" # grouping var
# blocks
data <- alldata[alldata$block_size == 4,]
blocks <- data[data$trial_number == max(data$trial_number),]
# calc avg score per pp across blocks
cdata.n <- aggregate(blocks["regret"], by=blocks[c(agg)], FUN=length)
names(cdata.n)[names(cdata.n)=="regret"] <- "n"
cdata.m <- aggregate(blocks["regret"], by=blocks[c(agg)], FUN=mean)
names(cdata.m)[names(cdata.m)=="regret"] <- "m"
cdata.sd <- aggregate(blocks["regret"], by=blocks[c(agg)], FUN=sd)
names(cdata.sd)[names(cdata.sd)=="regret"] <- "sd"

cdata <- merge(cdata.n, cdata.m)
cdata <- merge(cdata, cdata.sd)
cdata$se <- cdata$sd / sqrt(cdata$n)
cdata$m.sc <- scale(cdata$m, center = TRUE, scale = TRUE)
cdata$sd.sc <- scale(cdata$sd, center = TRUE, scale = TRUE)
cdata4 = cdata
```

```{r, results='asis'}
cdata$age_group = "old"
cdata$age_group[as.integer(as.character(cdata$id)) < 100] = "young"
cdata <- cdata[order(cdata$age_group, cdata$m, decreasing = TRUE),]
stargazer(cdata, summary = FALSE, header=FALSE, rownames = FALSE,
          title = "Regret across 4 option blocks",
          digits = 2, digits.extra = 2, initial.zero = FALSE,
          label = "mspblocks",
          font.size = "tiny")
```


```{r}
cdata.test <- ddply(cdata, .(age_group), summarize,
                    n = length(n),
                    m = mean(m),
					m.sc = mean(m.sc),
                    sd = mean(sd),
					sd.sc = mean(sd.sc),
                    se = mean(se))
# cdata.test
```

```{r, results='asis'}
stargazer(cdata.test, summary = FALSE, header=FALSE, rownames = FALSE,
          title = "Score (m) and speed (sp) across groups",
          digits = 2, digits.extra = 2, initial.zero = FALSE,
          label = "mspgroups",
          font.size = "tiny")
```


```{r, echo=FALSE}
agg = "id" # grouping var
# blocks
data <- alldata[alldata$block_size == 8,]
blocks <- data[data$trial_number == max(data$trial_number),]
# calc avg score per pp across blocks
cdata.n <- aggregate(blocks["regret"], by=blocks[c(agg)], FUN=length)
names(cdata.n)[names(cdata.n)=="regret"] <- "n"
cdata.m <- aggregate(blocks["regret"], by=blocks[c(agg)], FUN=mean)
names(cdata.m)[names(cdata.m)=="regret"] <- "m"
cdata.sd <- aggregate(blocks["regret"], by=blocks[c(agg)], FUN=sd)
names(cdata.sd)[names(cdata.sd)=="regret"] <- "sd"
cdata <- merge(cdata.n, cdata.m)
cdata <- merge(cdata, cdata.sd)
cdata$se <- cdata$sd / sqrt(cdata$n)
cdata$sd.sc <- scale(cdata$sd, center = TRUE, scale = TRUE)
cdata8 = cdata
```


```{r, results='asis'}
cdata$age_group = "old"
cdata$age_group[as.integer(as.character(cdata$id)) < 100] = "young"
cdata <- cdata[order(cdata$age_group, cdata$m, decreasing = TRUE),]
stargazer(cdata, summary = FALSE, header=FALSE, rownames = FALSE,
          title = "Regret across 8 option blocks",
          digits = 2, digits.extra = 2, initial.zero = FALSE,
          label = "mspblocks",
          font.size = "tiny")
```


```{r}
cdata.test <- ddply(cdata, .(age_group), summarize,
                    n = length(n),
                    m = mean(m),
                    sd = mean(sd),
					sd.sc = mean(sd.sc),
                    se = mean(se))
# cdata.test
```

```{r, results='asis'}
stargazer(cdata.test, summary = FALSE, header=FALSE, rownames = FALSE,
          title = "Score (m) and speed (sp) across groups",
          digits = 2, digits.extra = 2, initial.zero = FALSE,
          label = "mspgroups",
          font.size = "tiny")
```

\newpage 

